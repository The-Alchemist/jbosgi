<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Provided Examples - JBoss OSGi</title>

    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE8" />
    <meta content="Scroll Wiki Publisher" name="generator"/>

    <link type="text/css" rel="stylesheet" href="css/blueprint/liquid.css" media="screen, projection"/>
    <link type="text/css" rel="stylesheet" href="css/blueprint/print.css" media="print"/>
    <!--[if lt IE 8]><link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection"/><![endif]-->

    <link type="text/css" rel="stylesheet" href="css/content-style.css" media="screen, projection, print"/>
    <link type="text/css" rel="stylesheet" href="css/screen.css" media="screen, projection"/>
    <link type="text/css" rel="stylesheet" href="css/print.css" media="print"/>
    
    <link type="text/css" rel="stylesheet" href="css/jbossorg.css"/>
    <link type="text/css" rel="stylesheet" href="css/docnav.css"/>    
    
    <link type="text/css" rel="stylesheet" href="sh/shCore.css"/>
    <link type="text/css" rel="stylesheet" href="sh/shCoreDefault.css"/>
    <script type="text/javascript" src="sh/shCore.js"></script>
    <script type="text/javascript" src="sh/shBrushAppleScript.js"></script>
    <script type="text/javascript" src="sh/shBrushAS3.js"></script>
    <script type="text/javascript" src="sh/shBrushBash.js"></script>
    <script type="text/javascript" src="sh/shBrushCpp.js"></script>
    <script type="text/javascript" src="sh/shBrushCSharp.js"></script>
    <script type="text/javascript" src="sh/shBrushCss.js"></script>
    <script type="text/javascript" src="sh/shBrushDiff.js"></script>
    <script type="text/javascript" src="sh/shBrushErlang.js"></script>
    <script type="text/javascript" src="sh/shBrushGroovy.js"></script>
    <script type="text/javascript" src="sh/shBrushJava.js"></script>
    <script type="text/javascript" src="sh/shBrushJavaFX.js"></script>
    <script type="text/javascript" src="sh/shBrushJScript.js"></script>
    <script type="text/javascript" src="sh/shBrushPerl.js"></script>
    <script type="text/javascript" src="sh/shBrushPhp.js"></script>
    <script type="text/javascript" src="sh/shBrushPlain.js"></script>
    <script type="text/javascript" src="sh/shBrushPython.js"></script>
    <script type="text/javascript" src="sh/shBrushRuby.js"></script>
    <script type="text/javascript" src="sh/shBrushScala.js"></script>
    <script type="text/javascript" src="sh/shBrushSql.js"></script>
    <script type="text/javascript" src="sh/shBrushVb.js"></script>
    <script type="text/javascript" src="sh/shBrushXml.js"></script>
    
</head>
<body>
    <div class="container" style="min-width: 760px;">
        <div class="block header">
          <p id="title">
            <a class="site_href" href="http://www.jboss.org"><strong>JBoss.org</strong></a>
            <a class="doc_href" href="http://docs.jboss.org"><strong>Community Documentation</strong></a>
          </p>
                  <ul class="docnav">
                                                                                                                                              <li class="previous"><a accesskey="p" href="Arquillian_Test_Framework.html"><strong>Prev</strong></a></li>
                                                                                                                                                                                                                                                      <li class="next"><a accesskey="n" href="References.html"><strong>Next</strong></a></li>
                                            </ul>
                    <div>
            <h1>Provided Examples</h1>
          </div>          
          </div>

        <div class="block content">
    <div class="section-2"  id="4784855_ProvidedExamples-Content"  >
        <h2>Content</h2>
    
<ul class=" "><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-BuildandRuntheExamples">Build and Run the Examples</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-ExamplesforStandalone%26RemoteWildFly">Examples for Standalone &amp; Remote WildFly</a>    </p>
<ul class=" "><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-BlueprintContainer">Blueprint Container</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-ConfigurationAdmin">Configuration Admin</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-DeclarativeServices">Declarative Services</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-EventAdmin">Event Admin</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-JNDIService">JNDI Service</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-JMXService">JMX Service</a>    </p>
</li></ul></li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-ExamplesforWildFlyIntegration">Examples for WildFly Integration</a>    </p>
<ul class=" "><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-CDIIntegration">CDI Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-EARDeployments">EAR Deployments</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-EJB3Integration">EJB3 Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-HttpService">HttpService</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-JAXBIntegration">JAXB Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-JPAIntegration">JPA Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-JTAService">JTA Service</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-LifecycleInterceptor">Lifecycle Interceptor</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-ResourceInjection">Resource Injection</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-RESTIntegration">REST Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-WebServicesIntegration">Web Services Integration</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-WebApplication">Web Application</a>    </p>
</li><li class=" ">    <p>
<a href="Provided_Examples.html#4784855_ProvidedExamples-XMLParserServices">XML Parser Services</a>    </p>
</li></ul></li></ul>    </div>
    
    <div class="section-2"  id="4784855_ProvidedExamples-BuildandRuntheExamples"  >
        <h2>Build and Run the Examples</h2>
    
    <p>
JBoss OSGi comes with a number of examples that demonstrate supported functionality and show best practices. All examples are part of the binary distribution and tightly integrated in our <a href="http://www.jboss.org/community/docs/DOC-13275">Maven Build Process</a>.    </p>
    <p>
The examples can be either run against an embedded OSGi framework or against WildFly. Here is how you build and run the standalone framework tests.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">[tdiesler@localhost example]$ mvn clean test
 
-------------------------------------------------------
 T E S T S
-------------------------------------------------------
Running org.jboss.test.osgi.example.blueprint.BlueprintTestCase
Tests run: 2, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 5.225 sec
...

Tests run: 22, Failures: 0, Errors: 0, Skipped: 1

[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESSFUL
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 13.846s
[INFO] Finished at: Fri Jun 28 10:24:25 CEST 2013
[INFO] Final Memory: 25M/202M
[INFO] ------------------------------------------------------------------------</pre>
        </div>
    </div>
    <p>
To run the examples against WildFly, you need to provide the target container that the runtime should connect to. This can be done with the <strong class=" ">target.container</strong> system property.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">    mvn -Dtarget.container=wildfly800 test</pre>
        </div>
    </div>
    </div>
    
    <div class="section-2"  id="4784855_ProvidedExamples-ExamplesforStandalone%26RemoteWildFly"  >
        <h2>Examples for Standalone &amp; Remote WildFly</h2>
    
    <p>
This section covers example tests that run both in the standalone and remote WildFly runtimes.    </p>
    <div class="section-3"  id="4784855_ProvidedExamples-BlueprintContainer"  >
        <h3>Blueprint Container</h3>
    
    <p>
The <strong class=" ">BlueprintTestCase</strong> shows how a number of components can be wired together and registered as OSGi service through the Blueprint Container Service.    </p>
    <p>
The example uses this simple blueprint descriptor    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot; ...&gt;
  
  &lt;bean id=&quot;beanA&quot; class=&quot;org.jboss.test.osgi.example.blueprint.bundle.BeanA&quot;&gt;
    &lt;property name=&quot;mbeanServer&quot; ref=&quot;mbeanService&quot;/&gt;
  &lt;/bean&gt;
  
  &lt;service id=&quot;serviceA&quot; ref=&quot;beanA&quot; interface=&quot;org.jboss.test.osgi.example.blueprint.bundle.ServiceA&quot;&gt;
  &lt;/service&gt;
  
  &lt;service id=&quot;serviceB&quot; interface=&quot;org.jboss.test.osgi.example.blueprint.bundle.ServiceB&quot;&gt;
    &lt;bean class=&quot;org.jboss.test.osgi.example.blueprint.bundle.BeanB&quot;&gt;
       &lt;property name=&quot;beanA&quot; ref=&quot;beanA&quot;/&gt;
    &lt;/bean&gt;
  &lt;/service&gt;
  
  &lt;reference id=&quot;mbeanService&quot; interface=&quot;javax.management.MBeanServer&quot;/&gt;

&lt;/blueprint&gt;</pre>
        </div>
    </div>
    <p>
The Blueprint Container registers two services <strong class=" ">ServiceA</strong> and <strong class=" ">ServiceB</strong>. ServiceA is backed up by <strong class=" ">BeanA</strong>, ServiceB is backed up by the anonymous <strong class=" ">BeanB</strong>. BeanA is injected into BeanB and the <strong class=" ">MBeanServer</strong> gets injected into BeanA. Both beans are plain POJOs. There is <strong class=" ">no BundleActivator</strong> neccessary to register the services.    </p>
    <p>
The example test verifies the correct wiring like this    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">@Test
public void testServiceA() throws Exception
{
  ServiceReference&lt;ServiceA&gt; srefA = context.getServiceReference(ServiceA.class);
  assertNotNull(&quot;ServiceA not null&quot;, srefA);
  
  ServiceA serviceA = context.getService(srefA);
  MBeanServer mbeanServer = serviceA.getMbeanServer();
  assertNotNull(&quot;MBeanServer not null&quot;, mbeanServer);

  ServiceReference&lt;ServiceB&gt; srefB = context.getServiceReference(ServiceB.class);
  assertNotNull(&quot;ServiceB not null&quot;, srefB);
  
  ServiceB serviceB = context.getService(sref);
  BeanA beanA = serviceB.getBeanA();
  assertNotNull(&quot;BeanA not null&quot;, beanA);
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-ConfigurationAdmin"  >
        <h3>Configuration Admin</h3>
    
    <p>
The <strong class=" ">ConfigurationAdminTestCase</strong> shows how an OSGi <a href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/cm/ManagedService.html">ManagedService</a> can be configured through the <a href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/cm/ConfigurationAdmin.html">ConfigurationAdmin</a> service.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testManagedService() throws Exception {

   // Get the {@link Configuration} for the given PID
   Configuration config = configAdmin.getConfiguration(ConfiguredService.SERVICE_PID);
   assertNotNull(&quot;Config not null&quot;, config);

   Dictionary&lt;String, String&gt; configProps = new Hashtable&lt;String, String&gt;();
   configProps.put(&quot;foo&quot;, &quot;bar&quot;);
   config.update(configProps);

   // Register a {@link ManagedService}
   Dictionary&lt;String, String&gt; serviceProps = new Hashtable&lt;String, String&gt;();
   serviceProps.put(Constants.SERVICE_PID, ConfiguredService.SERVICE_PID);
   bundlecontext.registerService(new String[] { ConfiguredService.class.getName(), 
      ManagedService.class.getName() }, new ConfiguredService(), serviceProps);

   // Wait a little for the update event
   if (latch.await(5, TimeUnit.SECONDS) == false)
      throw new TimeoutException();

   // Verify service property
   ServiceReference sref = bundlecontext.getServiceReference(ConfiguredService.class.getName());
   ConfiguredService service = (ConfiguredService) bundlecontext.getService(sref);
   assertEquals(&quot;bar&quot;, service.getValue(&quot;foo&quot;));

   config.delete();
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-DeclarativeServices"  >
        <h3>Declarative Services</h3>
    
    <p>
The <strong class=" ">DeclarativeServicesTestCase</strong> shows how a service can be made available through a Declarative Services descriptor.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">&lt;component name=&quot;sample.component&quot; immediate=&quot;true&quot;&gt;
  &lt;implementation class=&quot;org.jboss.test.osgi.example.ds.SampleComparator&quot; /&gt;
  &lt;property name=&quot;service.description&quot; value=&quot;Sample Comparator Service&quot; /&gt;
  &lt;property name=&quot;service.vendor&quot; value=&quot;Apache Software Foundation&quot; /&gt;
  &lt;service&gt;
    &lt;provide interface=&quot;java.util.Comparator&quot; /&gt;
  &lt;/service&gt;
&lt;/component&gt;</pre>
        </div>
    </div>
    <p>
The test then verifies that the service becomes available    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testImmediateService() throws Exception {

  // Track the service provided by the test bundle
  final CountDownLatch latch = new CountDownLatch(1);
  ServiceTracker tracker = new ServiceTracker(context, Comparator.class.getName(), null) {
     public Object addingService(ServiceReference reference) {
         Comparator&lt;Object&gt; service = (Comparator&lt;Object&gt;) super.addingService(reference);
         latch.countDown();
         return service;
     }
  };
  tracker.open();

  // Wait for the service to become available
  if (latch.await(2, TimeUnit.SECONDS) == false)
    throw new TimeoutException(&quot;Timeout tracking Comparator service&quot;);
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-EventAdmin"  >
        <h3>Event Admin</h3>
    
    <p>
The <strong class=" ">EventAdminTestCase</strong> uses the <a href="http://www.osgi.org/javadoc/r4v42/org/osgi/service/event/EventAdmin.html">EventAdmin</a> service to send/receive events.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testEventHandler() throws Exception
{
  TestEventHandler eventHandler = new TestEventHandler();
  
  // Register the EventHandler
  Dictionary param = new Hashtable();
  param.put(EventConstants.EVENT_TOPIC, new String[Introduction] { TOPIC });
  context.registerService(EventHandler.class.getName(), eventHandler, param);

  // Send event through the the EventAdmin
  EventAdmin eventAdmin = EventAdminSupport.provideEventAdmin(context, bundle);
  eventAdmin.sendEvent(new Event(TOPIC, null));
  
  // Verify received event
  assertEquals(&quot;Event received&quot;, 1, eventHandler.received.size());
  assertEquals(TOPIC, eventHandler.received.get(0).getTopic());
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-JNDIService"  >
        <h3>JNDI Service</h3>
    
    <p>
The <strong class=" ">NamingStandaloneTestCase</strong> gets the <strong class=" ">JNDIContextManager</strong> service and verifies JNDI access.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">ServiceReference&lt;JNDIContextManager&gt; sref = context.getServiceReference(JNDIContextManager.class);
JNDIContextManager contextManager = context.getService(sref);</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">Context initialContext = contextManager.newInitialContext();
BundleContext context = (BundleContext) initialContext.lookup(&quot;osgi:framework/bundleContext&quot;);
Assert.assertEquals(bundle.getBundleContext(), context);</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-JMXService"  >
        <h3>JMX Service</h3>
    
    <p>
The <strong class=" ">MBeanServerTestCase</strong> tracks the MBeanServer service and registers a pojo with JMX. It then verifies the JMX access.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class MBeanActivator implements BundleActivator
{
   public void start(BundleContext context)
   {
      ServiceTracker tracker = new ServiceTracker(context, MBeanServer.class.getName(), null)
      {
         public Object addingService(ServiceReference reference)
         {
            MBeanServer mbeanServer = (MBeanServer)super.addingService(reference);
            registerMBean(mbeanServer);
            return mbeanServer;
         }

         @Override
         public void removedService(ServiceReference reference, Object service)
         {
            unregisterMBean((MBeanServer)service);
            super.removedService(reference, service);
         }
      };
      tracker.open();
   }

   public void stop(BundleContext context)
   {
      ServiceReference sref = context.getServiceReference(MBeanServer.class.getName());
      if (sref != null)
      {
         MBeanServer mbeanServer = (MBeanServer)context.getService(sref);
         unregisterMBean(mbeanServer);
      }
   }
   ...
}</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testMBeanAccess() throws Exception
{
   // Provide MBeanServer support
   MBeanServer server = ManagementSupport.provideMBeanServer(context, bundle);

   // Start the test bundle
   bundle.start();

   ObjectName oname = ObjectName.getInstance(FooMBean.MBEAN_NAME);
   FooMBean foo = ManagementSupport.getMBeanProxy(server, oname, FooMBean.class);
   assertEquals(&quot;hello&quot;, foo.echo(&quot;hello&quot;));
}</pre>
        </div>
    </div>
    <p>
The <strong class=" ">BundleStateTestCase</strong> uses JMX to control the bundle state through the BundleStateMBean.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testBundleStateMBean() throws Exception
{
   MBeanServer server = ManagementSupport.provideMBeanServer(context, bundle);

   ObjectName oname = ObjectName.getInstance(BundleStateMBean.OBJECTNAME);
   BundleStateMBean bundleState =  ManagementSupport.getMBeanProxy(server, oname, BundleStateMBean.class);
   assertNotNull(&quot;BundleStateMBean not null&quot;, bundleState);

   TabularData bundleData = bundleState.listBundles();
   assertNotNull(&quot;TabularData not null&quot;, bundleData);
   assertFalse(&quot;TabularData not empty&quot;, bundleData.isEmpty());
}</pre>
        </div>
    </div>
    </div>
    
    </div>
    
    <div class="section-2"  id="4784855_ProvidedExamples-ExamplesforWildFlyIntegration"  >
        <h2>Examples for WildFly Integration</h2>
    
    <p>
This section covers example tests that only run both in the remote WildFly integration.    </p>
    <div class="section-3"  id="4784855_ProvidedExamples-CDIIntegration"  >
        <h3>CDI Integration</h3>
    
    <p>
The <strong class=" ">ManagedBeansTestCase</strong> deploys and EAR file that contains a WAR and three bundles. The first bundle tracks payment service providers    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">    private BundleContext context;

    @Resource
    public void setContext(BundleContext context) {
        this.context = context;
    }

    private List&lt;PaymentProvider&gt; providers = new ArrayList&lt;PaymentProvider&gt;();

    @PostConstruct
    @SuppressWarnings({ &quot;unchecked&quot;, &quot;rawtypes&quot; })
    public void start() {
        ServiceTracker tracker = new ServiceTracker(context, PaymentProvider.class.getName(), null) {

            @Override
            public Object addingService(ServiceReference reference) {
                PaymentProvider service = (PaymentProvider) super.addingService(reference);
                providers.add(service);
                return service;
            }

            @Override
            public void removedService(ServiceReference reference, Object service) {
                providers.remove(service);
                super.removedService(reference, service);
            }
        };
        tracker.open();
    }</pre>
        </div>
    </div>
    <p>
The other two bundles each provide an OSGi payment service, which gets injected into the webapp via CDI. The advantage of this approach is that we can construct modular web applications from independent components (i.e. bundles) which have lifecyle. We can therefore easily add/remove/start/stop/update payment service providers.    </p>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-EARDeployments"  >
        <h3>EAR Deployments</h3>
    
    <p>
The <strong class=" ">EnterpriseArchiveTestCase</strong> shows that OSGi bundles can be deployed as part on an EAR. It is guaranteed the contained bundles all get 'installed' before they get 'resolved' and 'started'. With a large set of individual bundle deployments that have complex interdependencies it would be hard to deploy the bundles in the correct order. EAR deployments fix that ordering issue.    </p>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-EJB3Integration"  >
        <h3>EJB3 Integration</h3>
    
    <p>
The <strong class=" ">StatelessBeanTestCase</strong> verifies that an EJB can be deployed as OSGi bundle. The stateless session bean then accesses on OSGi services    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">@Stateless
@LocalBean
public class SimpleStatelessSessionBean implements Echo {

    @Resource
    BundleContext context;

    public String echo(String message) {
        if (context == null) 
           throw new IllegalStateException(&quot;BundleContext not injected&quot;);

        if (BUNDLE_SYMBOLICNAME.equals(message)) {
            Bundle bundle = getTargetBundle();
            return bundle.getSymbolicName();
        }
        ...
    }
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-HttpService"  >
        <h3>HttpService</h3>
    
    <p>
The <strong class=" ">HttpServiceTestCase</strong> deploys a Service that registeres a servlet and a resource with the <a href="http://www.osgi.org/javadoc/r4v41/org/osgi/service/http/HttpService.html">HttpService</a>.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">ServiceTracker tracker = new ServiceTracker(context, HttpService.class.getName(), null);
tracker.open();

HttpService httpService = (HttpService)tracker.getService();
if (httpService == null)
   throw new IllegalStateException(&quot;HttpService not registered&quot;);

Properties initParams = new Properties();
initParams.setProperty(&quot;initProp&quot;, &quot;SomeValue&quot;);
httpService.registerServlet(&quot;/servlet&quot;, new EndpointServlet(context), initParams, null);
httpService.registerResources(&quot;/file&quot;, &quot;/res&quot;, null);</pre>
        </div>
    </div>
    <p>
The test then verifies that the registered servlet context and the registered resource can be accessed.    </p>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-JAXBIntegration"  >
        <h3>JAXB Integration</h3>
    
    <p>
The <strong class=" ">XMLBindingTestCase</strong> verifies that an OSGi bundle can use the JAXB integration that is available in WildFly    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">        builder.addImportPackages(&quot;javax.xml.bind&quot;, &quot;javax.xml.bind.annotation&quot;);
        builder.addImportPackages(&quot;javax.xml.datatype&quot;, &quot;javax.xml.namespace&quot;);

        JAXBContext jaxbContext = JAXBContext.newInstance(ObjectFactory.class...);
        Unmarshaller unmarshaller = jaxbContext.createUnmarshaller();
        URL resURL = bundle.getResource(&quot;booking.xml&quot;);
        JAXBElement&lt;CourseBooking&gt; rootElement = unmarshaller.unmarshal(resURL.openStream());
        assertNotNull(&quot;root element not null&quot;, rootElement);</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-JPAIntegration"  >
        <h3>JPA Integration</h3>
    
    <p>
The <strong class=" ">PersistenceTestCase</strong> verifies that an OSGi bundle can use the Hibernate JPA integration in WildFly    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">        EntityManagerFactory emf = null;
        try {
            ServiceReference&lt;EntityManagerFactory&gt; sref = context.getServiceReference(EntityManagerFactory.class);
            emf = context.getService(sref);

            Employee emp = new Employee();
            emp.setId(100);
            emp.setAddress(&quot;Sesame Street&quot;);
            emp.setName(&quot;Kermit&quot;);

            EntityManager em = emf.createEntityManager();
            em.persist(emp);

            emp = em.find(Employee.class, 100);
            Assert.assertNotNull(&quot;Employee not null&quot;, emp);

            em.remove(emp);

        } finally {
            if (emf != null) {
                emf.close();
            }
        }</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-JTAService"  >
        <h3>JTA Service</h3>
    
    <p>
The <strong class=" ">TransactionTestCase</strong> gets the <a href="http://java.sun.com/javaee/5/docs/api/javax/transaction/UserTransaction.html">UserTransaction</a> service and registers a transactional user object (i.e. one that implements <a href="http://java.sun.com/javaee/5/docs/api/javax/transaction/Synchronization.html">Synchronization</a>) with the <a href="http://java.sun.com/javaee/5/docs/api/javax/transaction/TransactionManager.html">TransactionManager</a> service. It then verifies that modifications on the user object are transactional.    </p>
    <p>
This functionality is only available in the context of AS7.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">Transactional txObj = new Transactional();

ServiceReference userTxRef = context.getServiceReference(UserTransaction.class.getName());
assertNotNull(&quot;UserTransaction service not null&quot;, userTxRef);

UserTransaction userTx = (UserTransaction)context.getService(userTxRef);
assertNotNull(&quot;UserTransaction not null&quot;, userTx);

userTx.begin();
try
{
   ServiceReference tmRef = context.getServiceReference(TransactionManager.class.getName());
   assertNotNull(&quot;TransactionManager service not null&quot;, tmRef);
   
   TransactionManager tm = (TransactionManager)context.getService(tmRef);
   assertNotNull(&quot;TransactionManager not null&quot;, tm);
   
   Transaction tx = tm.getTransaction();
   assertNotNull(&quot;Transaction not null&quot;, tx);
   
   tx.registerSynchronization(txObj);
   
   txObj.setMessage(&quot;Donate $1.000.000&quot;);
   assertNull(&quot;Uncommited message null&quot;, txObj.getMessage());
   
   userTx.commit();
}
catch (Exception e)
{
   userTx.setRollbackOnly();
}

assertEquals(&quot;Donate $1.000.000&quot;, txObj.getMessage());</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">class Transactional implements Synchronization
{
  public void afterCompletion(int status)
  {
     if (status == Status.STATUS_COMMITTED)
        message = volatileMessage;
  }
  
  ...      
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-LifecycleInterceptor"  >
        <h3>Lifecycle Interceptor</h3>
    
    <p>
The <strong class=" ">LifecycleInterceptorTestCase</strong> deployes a bundle that contains some metadata and an interceptor bundle that processes the metadata and registeres an http endpoint from it. The idea is that the bundle does not process its own metadata. Instead this work is delegated to some specialized metadata processor (i.e. the interceptor).    </p>
    <p>
Each interceptor is itself registered as a service. This is the well known <a href="http://www.osgi.org/wiki/uploads/Links/whiteboard.pdf">Whiteboard Pattern</a>.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class InterceptorActivator implements BundleActivator
{
   public void start(BundleContext context)
   {
      LifecycleInterceptor publisher = new PublisherInterceptor();
      LifecycleInterceptor parser = new ParserInterceptor();
      
      // Add the interceptors, the order of which is handles by the service
      context.registerService(LifecycleInterceptor.class.getName(), publisher, null);
      context.registerService(LifecycleInterceptor.class.getName(), parser, null);
   }
}</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class ParserInterceptor extends AbstractLifecycleInterceptor
{
   ParserInterceptor()
   {
      // Add the provided output
      addOutput(HttpMetadata.class);
   }

   public void invoke(int state, InvocationContext context)
   {
      // Do nothing if the metadata is already available  
      HttpMetadata metadata = context.getAttachment(HttpMetadata.class);
      if (metadata != null)
         return;

      // Parse and create metadta on STARTING
      if (state == Bundle.STARTING)
      {
          VirtualFile root = context.getRoot();
          VirtualFile propsFile = root.getChild(&quot;/http-metadata.properties&quot;);
          if (propsFile != null)
          {
             log.info(&quot;Create and attach HttpMetadata&quot;);
             metadata = createHttpMetadata(propsFile);
             context.addAttachment(HttpMetadata.class, metadata);
          }
      }
   }
   ...
}</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class PublisherInterceptor extends AbstractLifecycleInterceptor
{
   PublisherInterceptor()
   {
      // Add the required input
      addInput(HttpMetadata.class);
   }

   public void invoke(int state, InvocationContext context)
   {
      // HttpMetadata is guaratied to be available because we registered
      // this type as required input
      HttpMetadata metadata = context.getAttachment(HttpMetadata.class);

      // Register HttpMetadata on STARTING 
      if (state == Bundle.STARTING)
      {
         String servletName = metadata.getServletName();

         // Load the endpoint servlet from the bundle
         Bundle bundle = context.getBundle();
         Class servletClass = bundle.loadClass(servletName);
         HttpServlet servlet = (HttpServlet)servletClass.newInstance();

         // Register the servlet with the HttpService
         HttpService httpService = getHttpService(context, true);
         httpService.registerServlet(&quot;/servlet&quot;, servlet, null, null);
      }

      // Unregister the endpoint on STOPPING 
      else if (state == Bundle.STOPPING)
      {
         log.info(&quot;Unpublish HttpMetadata: &quot; + metadata);
         HttpService httpService = getHttpService(context, false);
         if (httpService != null)
            httpService.unregister(&quot;/servlet&quot;);
      }
   }
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-ResourceInjection"  >
        <h3>Resource Injection</h3>
    
    <p>
The <strong class=" ">ResourceInjectionTestCase</strong> verifies that resources can be injected in OSGi bundle activators.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public class ResourceInjectionActivator implements BundleActivator {

    @Resource(name = &quot;java:jboss/datasources/ExampleDS&quot;)
    public DataSource ds;

    public void start(BundleContext context) throws Exception {
        String productName = ds.getConnection().getMetaData().getDatabaseProductName();
        ...
    }
}</pre>
        </div>
    </div>
    <p>
    </p>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-RESTIntegration"  >
        <h3>REST Integration</h3>
    
    <p>
The <strong class=" ">RestEndpointTestCase</strong> verifies that OSGi bundles can provide REST endpoints. REST endpoints can therefore be part of larger modular applications and have lifecycle - they can be started/stopped/updated, etc. REST endpoints can access OSGi services.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">@Path(&quot;/rest&quot;)
@Consumes({ &quot;application/json&quot; })
@Produces({ &quot;application/json&quot; })
public class SimpleRestEndpoint {

    private static final Logger log = Logger.getLogger(SimpleRestEndpoint.class);

    @Resource
    private BundleContext context;

    @GET
    @Path(&quot;/echo/{message}&quot;)
    public String echo(@PathParam(&quot;message&quot;) String message) {
        ServiceReference&lt;Echo&gt; sref = context.getServiceReference(Echo.class);
        return context.getService(sref).echo(message);
    }
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-WebServicesIntegration"  >
        <h3>Web Services Integration</h3>
    
    <p>
The <strong class=" ">WebServiceEndpointTestCase</strong> verifies that OSGi bundles can provide WebService endpoints. WebService endpoints can therefore be part of larger modular applications and have lifecycle - they can be started/stopped/updated, etc. WebService endpoints can access OSGi services.    </p>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-WebApplication"  >
        <h3>Web Application</h3>
    
    <p>
The <strong class=" ">WebAppTestCase</strong> deploys an OSGi Web Application Bundle (WAB). Similar to HTTP Service Example it registers a servlet and resources with the WebApp container. This is done through a standard web.xml descriptor.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; ... version=&quot;2.5&quot;&gt;

  &lt;display-name&gt;WebApp Sample&lt;/display-name&gt;

  &lt;servlet&gt;
    &lt;servlet-name&gt;servlet&lt;/servlet-name&gt;
    &lt;servlet-class&gt;org.jboss.test.osgi.example.webapp.bundle.EndpointServlet&lt;/servlet-class&gt;
    &lt;init-param&gt;
      &lt;param-name&gt;initProp&lt;/param-name&gt;
      &lt;param-value&gt;SomeValue&lt;/param-value&gt;
    &lt;/init-param&gt;
  &lt;/servlet&gt;

  &lt;servlet-mapping&gt;
    &lt;servlet-name&gt;servlet&lt;/servlet-name&gt;
    &lt;url-pattern&gt;/servlet&lt;/url-pattern&gt;
  &lt;/servlet-mapping&gt;

&lt;/web-app&gt;</pre>
        </div>
    </div>
    <p>
The associated OSGi manifest looks like this.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">Manifest-Version: 1.0
Bundle-ManifestVersion: 2
Bundle-SymbolicName: example-webapp
Bundle-ClassPath: .,WEB-INF/classes
Web-ContextPath: example-webapp
Import-Package: javax.servlet,javax.servlet.http,...</pre>
        </div>
    </div>
    <p>
The test verifies that we can access the servlet and some resources.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">public void testServletAccess() throws Exception
{
   // Provide WebApp support
   WebAppSupport.provideWebappSupport(context, bundle);
        
   // Start the test bundle
   bundle.start();
        
   String line = getHttpResponse(&quot;/example-webapp/servlet?test=plain&quot;, 5000);
   assertEquals(&quot;Hello from Servlet&quot;, line);
}</pre>
        </div>
    </div>
    </div>
    
    <div class="section-3"  id="4784855_ProvidedExamples-XMLParserServices"  >
        <h3>XML Parser Services</h3>
    
    <p>
The XML parser test cases get a DocumentBuilderFactory/SAXParserFactory respectivly and unmarshalls an XML document using that parser.    </p>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">DocumentBuilderFactory factory = XMLParserSupport.provideDocumentBuilderFactory(context, bundle);
factory.setValidating(false);

DocumentBuilder domBuilder = factory.newDocumentBuilder();
URL resURL = context.getBundle().getResource(&quot;example-xml-parser.xml&quot;);
Document dom = domBuilder.parse(resURL.openStream());
assertNotNull(&quot;Document not null&quot;, dom);</pre>
        </div>
    </div>
    <div class="confbox programlisting">
                <div class="content">
        <pre class="brush: java; gutter: false;">SAXParserFactory factory = XMLParserSupport.provideSAXParserFactory(context, bundle);
factory.setValidating(false);

SAXParser saxParser = factory.newSAXParser();
URL resURL = context.getBundle().getResource(&quot;example-xml-parser.xml&quot;);

SAXHandler saxHandler = new SAXHandler();
saxParser.parse(resURL.openStream(), saxHandler);
assertEquals(&quot;content&quot;, saxHandler.getContent());</pre>
        </div>
    </div>
    </div>
    
    </div>
    
        </div>
              <ul class="docnav">
                                                                                                                                            <li class="previous"><a accesskey="p" href="Arquillian_Test_Framework.html"><strong>Prev</strong>Arquillian Test Framework</a></li>
                                                    <li class="up"><a accesskey="u" href="#"><strong>Top of page</strong></a></li>
          <li class="home"><a accesskey="h" href="User_Guide.html"><strong>Front page</strong></a></li>
                                                                                                                                                                                                          <li class="next"><a accesskey="n" href="References.html"><strong>Next</strong>References</a></li>
                                          </ul>
          </div>
    <script type="text/javascript">
      SyntaxHighlighter.all()
    </script>
</body>
</html>
